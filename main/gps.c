/**
 * @file gps.c
 * @author
 * @date
 * @brief
 */

//=============================================================================
// [Inclusions] ===============================================================
#include "driver/gpio.h"
#include "esp_log.h"

#include "gps.h"
#include "nmea_parser.h"

//=============================================================================

//=============================================================================
// [Private Defines] ==========================================================
#define GPS_TAG				"[GPS]"

#define GPS_GPIO_3D_FIX   	GPIO_NUM_17

//=============================================================================

//=============================================================================
// [Local Typedef] ============================================================

//=============================================================================

//=============================================================================
// [External Data Definitions] ================================================

// Const ---------------------------------------------
//----------------------------------------------------

// Vars ----------------------------------------------
//----------------------------------------------------

// Task Handlers -------------------------------------
//----------------------------------------------------

// Queue Handlers ------------------------------------
//----------------------------------------------------

// Event Group Handlers ------------------------------
//----------------------------------------------------

// Semaphore Handlers --------------------------------
//----------------------------------------------------

//=============================================================================

//=============================================================================
// [Local Data Declarations] ==================================================

// Const ---------------------------------------------
//----------------------------------------------------

// Vars ----------------------------------------------
static gps_t gps = {0};

//----------------------------------------------------

// Task Handlers -------------------------------------
//----------------------------------------------------

// Queue Handlers ------------------------------------
//----------------------------------------------------

// Event Group Handlers ------------------------------
//----------------------------------------------------

// Semaphore Handlers --------------------------------
//----------------------------------------------------

//=============================================================================

//=============================================================================
// [Local Function Declarations] ==============================================

/**
 * @details
 * @param[in]
 * @param[in]
 * @return
 */
static void gps_event_handler(void *event_handler_arg, esp_event_base_t event_base, int32_t event_id, void *event_data);

//=============================================================================

//=============================================================================
// [FreeRTOS Task Definitions] ================================================


//=============================================================================

//=============================================================================
// [Local Function Definitions] ===============================================



static void gps_event_handler(void *event_handler_arg, esp_event_base_t event_base, int32_t event_id, void *event_data)
{
    switch (event_id)
    {
    	case GPS_UPDATE:
			gps = *(gps_t *)event_data;
        break;

    	default:
    		//Nothing to do.
        break;
    }
}

//=============================================================================

//=============================================================================
// [External Function Definition] =============================================

void gps_init(void)
{
	gpio_pad_select_gpio(GPS_GPIO_3D_FIX);
	gpio_set_direction(GPS_GPIO_3D_FIX, GPIO_MODE_INPUT);

	ESP_LOGI(GPS_TAG, "GPS_GPIO_3D_FIX: %u", gpio_get_level(GPS_GPIO_3D_FIX));

	/* NMEA parser configuration */
	nmea_parser_config_t config = NMEA_PARSER_CONFIG_DEFAULT();
	/* init NMEA parser library */
	nmea_parser_handle_t nmea_hdl = nmea_parser_init(&config);
	/* register event handler for NMEA parser library */
	nmea_parser_add_handler(nmea_hdl, gps_event_handler, NULL);
}

float_t gps_get_latitude(void)
{
    return gps.latitude;
}

float_t gps_get_longitude(void)
{
    return gps.longitude;
}

bool gps_get_valid(void)
{
    return gps.valid;
}

float_t gps_get_speed(void)
{
    return gps.speed;
}

float_t gps_get_course(void)
{
    return gps.cog;
}

uint8_t gps_get_sats(void)
{
    return gps.sats_in_use;
}

void gps_sleep(bool sleep)
{

}


//=============================================================================

//====================== [End Document] =======================================
